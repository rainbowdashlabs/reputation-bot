package de.chojo.repbot.web;

import de.chojo.repbot.dao.provider.Metrics;
import de.chojo.repbot.web.erros.ApiException;
import de.chojo.repbot.web.routes.v1.MetricsRoute;
import io.javalin.Javalin;
import org.slf4j.Logger;

import static io.javalin.apibuilder.ApiBuilder.before;
import static io.javalin.apibuilder.ApiBuilder.path;
import static org.slf4j.LoggerFactory.getLogger;

public class Api {
    private static final Logger log = getLogger(Api.class);
    private final Javalin javalin;
    private final MetricsRoute metricsRoute;

    public Api(Javalin javalin, Metrics metrics) {
        this.javalin = javalin;
        metricsRoute = new MetricsRoute(metrics);
    }

    public void init() {
        javalin.exception(ApiException.class, (err, ctx) -> ctx.result(err.getMessage()).status(err.status()));
        javalin.routes(() -> {
            before(ctx -> log.debug("Received request on {}.", ctx.path()));

            path("v1", () -> path("metrics", metricsRoute::buildRoutes));
        });
    }
}
